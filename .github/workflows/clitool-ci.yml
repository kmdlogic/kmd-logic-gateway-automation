name: CLI Tool CI

env:
  PROJPATH: './src/Kmd.Logic.Gateway.Automation.Tool'
  VERSION: '1.0.0'
  DOTNET_VERSION: '3.1.301'

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    - name: Install dependencies
      run: dotnet restore '${{ env.PROJPATH }}/Kmd.Logic.Gateway.Automation.Tool.csproj'
    - name: Build - DEBUG
      run: dotnet build '${{ env.PROJPATH }}/Kmd.Logic.Gateway.Automation.Tool.csproj' --configuration Debug --no-restore
      if: GITHUB_RUN_NUMBER.REF != 'refs/heads/master'
    - name: Build - RELEASE
      run: dotnet build '${{ env.PROJPATH }}/Kmd.Logic.Gateway.Automation.Tool.csproj' --configuration Release --no-restore
      if: GITHUB_RUN_NUMBER.REF == 'refs/heads/master'
    - name: Test
      run: dotnet test --no-restore --verbosity normal

    - name: Deploy - PRERELEASE
      uses: brandedoutcast/publish-nuget@v2.5.5
      if: github.ref == 'refs/heads/develop'
      with:
        PROJECT_FILE_PATH: '${{ env.PROJPATH }}/Kmd.Logic.Gateway.Automation.Tool.csproj'
        PACKAGE_NAME: Kmd.Logic.Gateway.Automation.Tool
        VERSION_STATIC: ${{ env.VERSION }}-$GITHUB_RUN_NUMBER
        NUGET_KEY: ${{ secrets.APIKEYNUGETGALLERY }}

    - name: Deploy - RELEASE
      uses: brandedoutcast/publish-nuget@v2.5.5
      if: github.ref == 'refs/heads/master'
      with:
        PROJECT_FILE_PATH: '${{ env.PROJPATH }}/Kmd.Logic.Gateway.Automation.Tool.csproj'
        PACKAGE_NAME: Kmd.Logic.Gateway.Automation.Tool
        VERSION_STATIC: ${{ env.VERSION }}
        NUGET_KEY: ${{ secrets.APIKEYNUGETGALLERY }}